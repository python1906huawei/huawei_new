ec.pkg("ec.member.myAddress");ec.load("ajax");ec.load("ec.box");ec.load("ec.dh");ec.member.myAddress.data={};ec.member.myAddress.list=function(addrList,addrFlag){var i,htmlFtl=[];$("#randomFlag").valS(addrFlag);if(addrList.length<0){$("#myAddress-record").hide();return}for(i=0;i<addrList.length;i++){ec.member.myAddress.data[addrList[i].id]=addrList[i];htmlFtl.push('<div class="list-group-item" id="myAddress-area-'+ec.autoEncodeAttr(addrList[i].id)+'">');htmlFtl.push('<table border="0" cellpadding="0" cellspacing="0">');htmlFtl.push("<tbody><tr>");htmlFtl.push('<td class="col-name">'+ec.autoEncodeAttr(addrList[i].consignee)+"</td>");if(addrList[i].provinceName==null){addrList[i].provinceName="  "}if(addrList[i].cityName==null){addrList[i].cityName="  "}if(addrList[i].districtName==null){addrList[i].districtName="  "}addrList[i].districtName=ec.address.replaceChar(addrList[i].districtName);htmlFtl.push('<td class="col-address">'+ec.autoEncodeAttr(addrList[i].provinceName)+"&nbsp;&nbsp;"+ec.autoEncodeAttr(addrList[i].cityName)+"&nbsp;&nbsp;"+ec.autoEncodeAttr(addrList[i].districtName)+"&nbsp;&nbsp;");if(addrList[i].streetName!=null&&addrList[i].streetName!=""){htmlFtl.push(ec.autoEncodeAttr(addrList[i].streetName)+"&nbsp;&nbsp;")}htmlFtl.push(ec.autoEncodeAttr(addrList[i].address)+"</td>");htmlFtl.push('<td class="col-zip">');if(addrList[i].zipCode){htmlFtl.push(ec.autoEncodeAttr(addrList[i].zipCode))}htmlFtl.push("</td>");htmlFtl.push('<td class="col-tel">');if(addrList[i].mobile&&addrList[i].mobile!=""){htmlFtl.push("<p>"+ec.autoEncodeAttr(addrList[i].mobile)+"</p>")}if(addrList[i].phone&&addrList[i].phone!=""){htmlFtl.push("<p>"+ec.autoEncodeAttr(addrList[i].phone)+"</p>")}htmlFtl.push("</td>");htmlFtl.push('<td class="col-operate"><p class="p-edit">');htmlFtl.push('<a class="edit" href="javascript:;" onclick="ec.member.myAddress.edit('+ec.autoEncodeAttr(addrList[i].id)+');" title="编辑"><span>编辑</span></a>');htmlFtl.push('</p><p class="p-del">');htmlFtl.push('<a class="del" href="javascript:;" onclick="ec.member.myAddress.del(this,'+ec.autoEncodeAttr(addrList[i].id)+');" title="删除"><span>删除</span></a>');htmlFtl.push('</p><p class="p-state">');if(addrList[i].defaultFlag==1){ec.member.myAddress.defaultId=addrList[i].id;htmlFtl.push('<span class="default">默认地址</span>')}else{htmlFtl.push('<a class="set " href="javascript:;" onclick="ec.member.myAddress.setDefault('+ec.autoEncodeAttr(addrList[i].id)+')" title="设为默认收货地址"><span>设为默认</span></a>')}htmlFtl.push("</p></td></tr></tbody></table></div>")}$("#list-group").html(htmlFtl.join(""));$("#myAddress-record").show()};ec.member.myAddress.save=function(form){var formObj=$(form);var type="update";if(formObj.attr("data-type")=="add"){type="add"}ec.addr.save(form,{type:type,successFunction:function(){var id=formObj.find("input[name=id]").val();var buttonName=$("#button-ok").val();$("#current-address").removeClass("form-address-detailcon").addClass("form-address-detail");new ec.box($("#success-tips").val(),{boxclass:"ol_box_4",showCancel:false,onopen:function(box){if(buttonName=="添加新地址"){box.find(".box-right-1 span").html("恭喜您，已成功添加新地址！")}else{box.find(".box-right-1 span").html("恭喜您，已修改成功！")}$("#consignee-msg").removeClass("report-errors filter");$("#address-msg").removeClass("report-errors filter");box.setPosition()},onok:function(box){box.close()},onclose:function(){ec.member.myAddress.reset();ec.addr.list(ec.member.myAddress.list)}}).open()}});return false};ec.member.myAddress.edit=function(id){$("#myAddress-form #tel-msg").text("");var i,curData=ec.member.myAddress.data[id],lstLength=ec.member.myAddress.data.length;$("html,body").animate({scrollTop:$("#myAddress-edit").offset().top},200);$("#myAddress-form").removeAttr("data-type");$("#consignee").valS(curData.consignee);var distrackId="";if(curData.street!=""&&curData.street!=null){distrackId=curData.street}else{distrackId=curData.district}ec.address.setValue(curData);ec.address.queryData(ec.address.parseUrl(tree_url,distrackId),true,1,ec.address.getCitydistrict);$("#id").valS(curData.id);$("#address").valS(curData.address);$("#address").prevAll("label").hide();$("#phone").prevAll("label").hide();$("#mobile").prevAll("label").hide();$("#zipCode").valS(curData.zipCode);$("#mobile").valS(curData.mobile);$("#phone").valS(curData.phone);$("#button-ok").val("确  定");$("#button-cancel span").html("取&nbsp;&nbsp;消");if(curData.id==ec.member.myAddress.defaultId){$("#myAddress-default").prop("checked",true).attr("disabled","disabled")}else{$("#myAddress-default").prop("checked",false).removeAttr("disabled")}$("#myAddress-form input").removeClass("error");$("#myAddress-form label.label-error").removeClass("label-error");$("#myAddress-msg").removeClass("label-error");$("#myAddress-msg").hide();$("#address-msg").removeClass("label-error");$("#address-msg").html("");$("#address").removeClass("error");$("#needL4Addr").valS(curData.needL4Addr)};ec.member.myAddress.reset=function(){$("#myAddress-form")[0].reset();ec.address.setDefaultAddress();$("#myAddress-form").attr("data-type","add");$("#button-ok").val("添加新地址");$("#button-cancel span").html("清&nbsp;&nbsp;空");$("#myAddress-form input").removeClass("error");$("#myAddress-default").prop("checked",false).removeAttr("disabled");$("#myAddress-form label.label-error").text("");$("#myAddress-form #tel-msg").text("");$("#myAddress-form label.label-error").removeClass("label-error");$("#myAddress-msg").removeClass("icon-error");$("#myAddress-msg").hide();$("#consignee-msg").removeClass("report-errors filter");$("#address-msg").removeClass("report-errors filter");ec.address.defaultTabValue();ec.address.cleanValue();$("#current-address").removeClass("form-address-detailcon").addClass("form-address-detail");ec.address.cleanFormValue()};ec.member.myAddress.del=function(dom,id){if(!ec.ui.confirm(dom,"您确认要删除该地址吗？")){return}ec.addr.del(id,{deleteDefault:ec.member.myAddress.changeDefaultId,successFunction:function(id){$("#myAddress-area-"+id).remove()}})};ec.member.myAddress.setDefault=function(id){ec.addr.setDefault(id,{successFunction:ec.member.myAddress.changeDefaultId})};ec.member.myAddress.changeDefaultId=function(id){$("#myAddress-area-"+id).find(".p-state").html("<span class='default'>默认地址</span>");$("#myAddress-area-"+ec.member.myAddress.defaultId).find(".p-state").html('<a class="set " href="javascript:;" onclick="ec.member.myAddress.setDefault('+ec.encodeForJS(ec.member.myAddress.defaultId)+')" title="设为默认收货地址"><span>设为默认</span></a>');if(ec.member.myAddress.defaultId!=id){$("#address-form-"+ec.member.myAddress.defaultId+" input[name=defaultFlag]").removeAttr("checked").removeAttr("disabled")}ec.member.myAddress.defaultId=id};ec.member.myAddress.bind=function(){form=$("#myAddress-form");var _vb=ec.form.validator.bind,consignee=form.find("input[name=consignee]"),zipCode=form.find("input[name=zipCode]"),address=form.find("textarea[name=address]"),phone=form.find("input[name=phone]"),mobile=form.find("input[name=mobile]"),currentAddress=form.find("input[name=district]");checkPhone=function(obj,options){var obj=obj.attr("name")==="mobile"?mobile:phone,showSpan=$(options.msg_ct);if($.trim(mobile.val()).length==0){mobile.addClass("error");$("#tel-msg").addClass("label-error");$("#tel-msg").html("手机号码不能为空")}else{if($.trim(obj.val()).length>0&&obj.hasClass("error")){return}else{if(mobile.hasClass("error")){$("#tel-msg").text("请填写正确的11位手机号码，例如：13XXXXXXXXX")}if(phone.hasClass("error")){$("#tel-msg").text("请填写正确的备选号码，固话格式为区号-主机-分机号")}if(!mobile.hasClass("error")&&!phone.hasClass("error")){$("#tel-msg").removeClass("label-error");$("#tel-msg").text("")}}}};currentCheckAddress=function(obj,options){var $form=$("#myAddress-form"),province=$form.find("input[name=province]").val(),city=$form.find("input[name=city]").val(),street=$form.find("input[name=street]").val(),district=$form.find("input[name=district]").val(),needL4Addr=$form.find("input[name=needL4Addr]").val();if($.trim($("#current-address").html())=="选择省-市-区-街道"){$("#myAddress-msg").addClass("icon-error label-error");$("#myAddress-msg").html("请填写完整的地区信息")}else if(""!=province&&""!=city&&""!=district){if(needL4Addr=="true"&&street==""){$("#myAddress-msg").addClass("icon-error label-error");$("#myAddress-msg").html("请填写完整的地区信息")}else{$("#myAddress-msg").removeClass("icon-error");$("#myAddress-msg").removeClass("label-error");$("#myAddress-msg").html("")}}else{$("#myAddress-msg").removeClass("icon-error");$("#myAddress-msg").removeClass("label-error");$("#myAddress-msg").html("")}};_vb(consignee,{type:["require","length","regex"],validOnChange:true,regex:/^[\uFF21-\uFF3A\uFF41-\uFF5A\u4E00-\u9FA5\s\u3000A-Za-z]+$/,min:2,max:20,msg_ct:"#"+consignee.attr("id")+"-msg",autoFocus:true,msg:{default:"",length:"收货人长度为2-20个字符，一个汉字为两个字符",regex:"收货人只能填写中文和英文字符",require:"请填写收货人"}});_vb(currentAddress,{type:["addressCheck"],validOnChange:true,msg_ct:"#myAddress-msg",autoFocus:true,msg:{default:"请填写完整的地区信息"},successFunction:currentCheckAddress});_vb(address,{type:["require","length","forbidChar2"],validOnChange:true,max:100,msg_ct:"#"+address.attr("id")+"-msg",autoFocus:true,msg:{forbidChar2:"收货人详细地址中含有非法字符",length:"详细地址最长为100个字符，一个汉字为两个字符",require:"请填写详细地址"}});_vb(zipCode,{type:["length","int"],validOnChange:true,min:6,max:6,msg_ct:"#"+zipCode.attr("id")+"-msg",autoFocus:true,msg:{default:"请填写正确的邮编"}});_vb(mobile,{type:["mobile"],validOnChange:true,msg_ct:"#"+mobile.attr("alt"),autoFocus:true,msg:{default:"请填写正确的11位手机号码，例如：13XXXXXXXXX"},successFunction:checkPhone});_vb(phone,{type:["mobleOrPhone"],validOnChange:true,msg_ct:"#"+phone.attr("alt"),autoFocus:true,msg:{default:"请填写正确的备选号码，固话格式为区号-主机-分机号"},successFunction:checkPhone});ec.form.input.label(address,"如选择不到您的地区，请在此处详细描述").label(phone,"固话或其他手机号码").label(mobile,"请输入11位手机号码")};$.extend(ec.form.validator.defaults,{errorClass:"error",autoFocus:false,errorFunction:function(obj,options){var css="label-error",msg=options.msg[options.type]||options.msg["default"];msg=msg.length<=0?"&nbsp;":msg;switch(options.type){case"require":css="label-error";break}if(options.msg_ct){$(options.msg_ct).addClass("label-error").html(ec.autoEncodeAttr(msg))}else{var id=(obj.attr("id")||obj.attr("name"))+"-msg";$("#"+id).remove();obj.after("<label id='"+id+"' class='label-error "+css+"'>"+ec.autoEncodeAttr(msg)+"</label>")}if(options.autoFocus)obj.focus()},successFunction:function(obj,options){if(!$(options.msg_ct).hasClass("filter")){if(options.msg_ct){$(options.msg_ct).html("").removeClass("label-error")}else{$("#"+(obj.attr("id")||obj.attr("name"))+"-msg").remove()}}}});ec.ready(function(){$("#li-myAddress").addClass("current");$("#pathTitle").html("收货地址管理");ec.addr.list(ec.member.myAddress.list);if(ec.isIE6){$(".list-group-item").hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")})}ec.member.myAddress.bind();new ec.address.oSearchSuggest(ec.address.sendKeyWordToBack);$("#current-address").click(function(){if($("#gouldAddress").val()==0){ec.address.processAddress()}else{$("#address-search").show()}});$(".btn-address-close").click(function(){ec.address.hiddenTips()});$(".form-address-search-text a").click(function(){ec.address.cleanKeyWord()})});