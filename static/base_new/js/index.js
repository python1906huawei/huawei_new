ec.load("ajax");ec.pkg("ec.member.myCenter");ec.member.myCenter.load=function(){if(ec.account.isLogin()){isLogin=true;var gradeCode=parseInt($("#myGradeCode").val());if(ec.isIE6||ec.isIE7){}else{(function(){var gradeCode=parseInt($("#myGradeCode").val());var max=$("#nextNeedScores").val();var min=$("#minScores").val();var interval=max-min;var userScores=$("#myUserScores").val();var cha=userScores-min;if(isNaN(interval)){interval=5e4}if(max==""){interval=5e4}if(cha>5e4){cha=5e4}var resultNum=cha/interval*100;if(isNaN(resultNum)){resultNum=0;userScores=0}if(resultNum<=0){resultNum=0}else{resultNum=Math.round(resultNum)}$("#canvas-index-member").attr("style","width: "+resultNum+"%");ec.member.myCenter.updateProgress(max,min,userScores,gradeCode)})()}ec.member.myCenter.orderCount()}};ec.member.myCenter.perCenter=function(){ec.util.cookie.set("userCenterFlag",true);ec.openWindow(accountCenterUrl)};ec.member.myCenter.orderCount=function(){$.ajax({url:domainMain+"/member/orderCount.json?t="+(new Date).getTime(),type:"get",async:false,timeout:1e4,success:function(json){json=JSON.parse(json);if(!json.success){return}var unPaidTotal=0;if(json.orderCount.unpaidOrderCount!=0||json.orderCount.partPaidOrderCount!=0){unPaidTotal+=parseInt(json.orderCount.unpaidOrderCount+json.orderCount.partPaidOrderCount);$("#un_payment").html("<em>"+unPaidTotal+"</em>")}if(json.orderCount.unpaidOrderCountWechat!=null&&json.orderCount.unpaidOrderCountWechat!=0){$("#un_payment_wechat").html("<em>"+parseInt(json.orderCount.unpaidOrderCountWechat)+"</em>")}var unreceiptOrderTotal=0;if(json.orderCount.unreceiptOrderCount!=0){unreceiptOrderTotal+=parseInt(json.orderCount.unreceiptOrderCount);$("#un_received").html("<em>"+unreceiptOrderTotal+"</em>")}if(json.orderCount.unreceiptOrderCountWechat!=null&&json.orderCount.unreceiptOrderCountWechat!=0){$("#un_received_wechat").html("<em>"+parseInt(json.orderCount.unreceiptOrderCountWechat)+"</em>")}var unpaidOrderCount6=$("#un_payment_wechat em").text()?$("#un_payment_wechat em").text():0,unreceiptOrderCount6=$("#un_received_wechat em").text()?$("#un_received_wechat em").text():0;var total=parseInt(unpaidOrderCount6)+parseInt(unreceiptOrderCount6);if(total==0){$("#li-order-small span").html("小程序订单")}else{$("#li-order-small span").html("小程序订单<em>("+total+")</em>")}ec.util.cookie.set("vmallOrderCountWechat",total)}});$.ajax({url:openApiDomain+"/rms/comment/getNoCommentPrdCount.json?t="+(new Date).getTime(),type:"POST",dataType:"json",async:false,data:JSON.stringify({tab:"nocomment",dateType:"1"}),beforeSend:function(xhr){xhr.withCredentials=true},success:function(json){if(json.resultCode!=0){return}if(json.data.count!=0){$("#un_remark").html("<em>"+json.data.count+"</em>")}var unpaidOrderCount=$("#un_payment em").text()?$("#un_payment em").text():0,unreceiptOrderCount=$("#un_received em").text()?$("#un_received em").text():0,notRemarkCount=$("#un_remark em").text()?$("#un_remark em").text():0;var total=parseInt(unpaidOrderCount)+parseInt(unreceiptOrderCount)+parseInt(notRemarkCount);if(total==0){$("#li-order span").html("我的订单");$("#portal-icon1").addClass("portal-icon-1 disabled");$("#portal-icon2").addClass("portal-icon-2 disabled");$("#portal-icon3").addClass("portal-icon-3 disabled");$("#portal-icon4").addClass("portal-icon-4 disabled");$("#portal-icon5").addClass("portal-icon-5 disabled")}else{$("#li-order span").html("我的订单<em>("+total+")</em>")}ec.util.cookie.set("vmallOrderCount",total)}})};ec.member.myCenter.updateProgress=function(max,min,totalPoint,gradeCode){var i=$("#user-vip-level-tips-index-member");if(gradeCode!=null){switch(gradeCode){case 0:vipColor="#999";i.attr("class","user-level icon-vip-level-0");break;case 1:vipColor="#01abdf";i.attr("class","user-level icon-vip-level-1");break;case 2:vipColor="#24ca43";i.attr("class","user-level icon-vip-level-2");break;case 3:vipColor="#ffb710";i.attr("class","user-level icon-vip-level-3");break;case 4:vipColor="#fc5d21";i.attr("class","user-level icon-vip-level-4");break;case 5:vipColor="#fc3784";i.attr("class","user-level icon-vip-level-5");break;default:vipColor="#999";i.attr("class","user-level icon-vip-level-0");break}}};ec.member.myCenter.showBox=function(){if($(".portal-icon-5").find("a").eq(0).attr("href")==undefined||$(".portal-icon-5").find("a").eq(0).attr("href")==""){new ec.box($("#modify-msg-tpl").val(),{boxclass:"ol_box_4",showButton:false,onok:function(box){box.close()}}).open()}else{}};ec.member.myCenter.exchangeConfirmForPoint=function(detailId,batchCode,activityCode){if(ec.account.isLogin()){validateBox=new ec.box($("#exchange_piont_Box").val(),{boxclass:"ol_box_4",title:"确认兑换",showButton:false,onopen:function(box){$("#exchange_name").text($("#exchange-point-name-"+detailId).text());$("#exchange_date").text("有效期："+$("#exchange-point-time-"+detailId).text());$("#exchange_point").text("兑换价："+$("#exchange-point-value-"+detailId).text());if($("#exchange-point-limit-"+detailId).val()!=""){$("#exchange_num").text("每人限兑"+$("#exchange-point-limit-"+detailId).val()+" 张")}else{$("#exchange_num").hide()}id=detailId;box.setPosition()},onclose:function(box){id=""}}).open();ec.member.myCenter.validateBind(id,batchCode,activityCode,1)}else{var casloginrul=$("#casloginurl").val();if(casloginrul!=null&&casloginrul!=""){var url=casloginrul+encodeURIComponent(encodeURIComponent(window.location.href));ec.redirectTo(url)}else{ec.redirectTo(loginUrl)}}};ec.member.myCenter.validateBind=function(id,batchCode,activityCode,type){$("#confirmExchange").click(function(){if(id==""){alert("参数无效");return}ec.member.myCenter.exchangeCoupon(id,batchCode,activityCode,type)});$("#cancelExchange").click(function(){validateBox.close()})};ec.member.myCenter.exchangeCoupon=function(detailId,batchCode,activityCode,type){var msg="";if(ec.account.isLogin()){$.ajax({url:openApiDomain+"/ams/coupon/receive?t="+(new Date).getTime(),type:"POST",dataType:"json",data:JSON.stringify({activityCode:activityCode,batchCode:batchCode}),timeout:1e4,beforeSend:function(xhr){xhr.withCredentials=true},success:function(json){var exchangePointValue=ec.autoEncodeAttr($("#exchange-point-value-"+detailId).text());if(json&&json.state){if(type==2){switch(json.state){case-1:$("#exchange-coupon-"+detailId).html("<a href='javascript:;' class='disabled'>已领完</a>");break;case 1:break;case 2:$("#exchange-coupon-"+detailId).html("<a href='javascript:;' class='disabled'>已领取</a>");break;case 3:$("#exchange-coupon-"+detailId).html("<a href='javascript:;' class='disabled'>即将开始</a>");break;case 4:$("#exchange-coupon-"+detailId).html("<a href='javascript:;' class='disabled'>已结束</a>");break;default:break}}else{switch(json.state){case-1:$("#exchange-point-"+detailId).html("<span id='exchange-point-value-"+detailId+"'>"+exchangePointValue+"</span><a href='javascript:;' class='disabled'>已兑完</a>");break;case 1:break;case 2:$("#exchange-point-"+detailId).html("<span id='exchange-point-value-"+detailId+"'>"+exchangePointValue+"</span><a href='javascript:;' class='disabled'>已兑换</a>");break;case 3:$("#exchange-point-"+detailId).html("<span id='exchange-point-value-"+detailId+"'>"+exchangePointValue+"</span><a href='javascript:;' class='disabled'>即将开始</a>");break;case 4:$("#exchange-point-"+detailId).html("<span id='exchange-point-value-"+detailId+"'>"+exchangePointValue+"</span><a href='javascript:;' class='disabled'>已结束</a>");break;default:break}}}if(json&&json.success){ec.member.myCenter.successDialogReceiveCoupon(json.pcReviceSuccTip,type);return}if(!json||!json.code){ec.member.myCenter.failureDialogReceiveCoupon("亲，瞬间被你的热情吓到了，容我缓缓，请稍候再来哦~",type);return}ec.member.myCenter.failureDialogReceiveCoupon(json.errorTip,type);return},error:function(){ec.member.myCenter.failureDialogReceiveCoupon("亲，瞬间被你的热情吓到了，容我缓缓，请稍候再来哦~",type);return}});$("#confirmExchange").addClass("disabled")}else{var casloginrul=$("#casloginurl").val();if(casloginrul!=null&&casloginrul!=""){var url=casloginrul+encodeURIComponent(encodeURIComponent(window.location.href));ec.redirectTo(url)}else{ec.redirectTo(loginUrl)}}};ec.member.myCenter.successDialogReceiveCoupon=function(messgage,type){var box=new ec.box($("#exchange_piont_Box_success").val(),{boxclass:"ol_box_4",showButton:false,onopen:function(box){if(type==2){$("#success_box_exchange").text("领取成功")}else{$("#success_box_exchange").html("兑换成功")}$("#success_box_exchange_msg").html(messgage)},onclose:function(box){}});box.open()};ec.member.myCenter.failureDialogReceiveCoupon=function(messgage,type){var box=new ec.box($("#exchange_piont_Box_error").val(),{boxclass:"ol_box_4",showButton:false,onopen:function(box){if(type==2){$("#error_box_exchange").text("领取失败")}else{$("#error_box_exchange").html("兑换失败")}$("#error_box_exchange_msg").html(messgage)},onclose:function(box){}});box.open()};ec.member.myCenter.roll=function(id,num){var len=$("#"+id).find(".swiper-slide").length;if(len<=num){$("#"+id).find(".swiper-button-next").addClass("disabled");$("#"+id).find(".swiper-button-prev").addClass("disabled")}else{$("#"+id).find(".swiper-button-next").removeClass("disabled")}var mySwiper=new Swiper("#"+id,{slidesPerView:num,slidesPerGroup:num});$("#"+id).find(".swiper-button-prev").click(function(){mySwiper.swipePrev()});$("#"+id).find(".swiper-button-next").click(function(){mySwiper.swipeNext()})};ec.member.myCenter.personalCenterLoad=function(){$.ajax({url:domainMain+"/member/personalcenter.json",type:"GET",timeout:1e4,dataType:"json",async:true,success:function(json){if(!json.success){$("#personal_center_box").hide();$("#personal_center_hr").hide()}else{var html=[],p,v;if(json.personalCenterList.length>0){for(var i=0;i<json.personalCenterList.length;i++){p=json.personalCenterList[i];if(p.recExpendType==1){html.push('<li class="p-coupon-1 swiper-slide">')}else{html.push('<li class="p-coupon-2 swiper-slide">')}if(p.limitLevel==0){html.push('<div class="p-level">V0-V5</div>')}else if(p.limitLevel>5){html.push('<div class="p-level">V5专享</div>')}else{var level=p.limitLevel-1;html.push('<div class="p-level">V'+level+"-V5</div>")}html.push('<div class="p-coupon">');html.push('<div style="display: none;"  id="exchange-point-time-'+p.id+'">'+ec.util.parseDate(p.promoValidBgtime).format("yyyy.MM.dd")+"-"+ec.util.parseDate(p.promoValidEndtime).format("yyyy.MM.dd")+"</div>");html.push('<input type="hidden"  id="exchange-point-limit-'+p.id+'" value="'+p.couponLimit+'"/>');if(p.promoType==1){html.push('<div class="p-price">&yen;<span>'+p.promoVal+"</span></div>")}else if(p.promoType==2){html.push('<div class="p-discount"><span>'+p.promoRat*10+"</span><em>折</em></div>")}else{html.push('<div class="p-postage">免邮券</div>')}html.push('<p class="p-name">优惠券</p></div>');html.push('<div class="p-title" id="exchange-point-name-'+p.id+'">'+p.promoName+"</div>");if(p.recExpendType==1){html.push('<div class="p-score" id="exchange-point-'+p.id+'">');html.push('<span id="exchange-point-value-'+p.id+'">'+p.expendValue+"积分</span>");if(p.couponState==-1){html.push('<a href="javascript:;" class="disabled">已兑完</a>')}else if(p.couponState==1){html.push('<a href="javascript:;" onclick="ec.member.myCenter.exchangeConfirmForPoint('+ec.encodeForJS(p.id)+",'"+ec.encodeForJS(p.batchCode)+"','"+ec.encodeForJS(p.activityCode)+"')\">立即兑换</a>")}else if(p.couponState==2){html.push('<a href="javascript:;" class="disabled">已兑换</a>')}else if(p.couponState==3){html.push('<a href="javascript:;" class="disabled">即将开始</a>')}else if(p.couponState==4){html.push('<a href="javascript:;" class="disabled">已结束</a>')}}else{html.push('<div class="p-score" id="exchange-coupon-'+p.id+'">');if(p.couponState==-1){html.push('<a href="javascript:;" class="disabled">已领完</a>')}else if(p.couponState==1){html.push('<a href="javascript:;" onclick="ec.member.myCenter.exchangeCoupon('+ec.encodeForJS(p.id)+",'"+ec.encodeForJS(p.batchCode)+"','"+ec.encodeForJS(p.activityCode)+"',2)\">立即领取</a>")}else if(p.couponState==2){html.push('<a href="javascript:;" class="disabled">已领取</a>')}else if(p.couponState==3){html.push('<a href="javascript:;" class="disabled">即将开始</a>')}else if(p.couponState==4){html.push('<a href="javascript:;" class="disabled">已结束</a>')}}html.push("</div></li>")}$("#personal_center_ul").html(html.join(""));$("#personal_center_box").show();$("#personal_center_hr").show()}else{$("#personal_center_box").hide();$("#personal_center_hr").hide()}ec.member.myCenter.roll("exchange-point-roll",3)}}})};ec.member.myCenter.myGridConfigLoad=function(){$.ajax({url:domainMain+"/member/gridconfig.json",type:"GET",dataType:"json",timeout:1e4,async:true,success:function(json){if(!json.success){$("#grid_config_box").hide();$("#grid_config_hr").hide()}else{var html=[],p,n;if(json.gridConfigList.length>0){html.push('<div class="mc-title"><h3>我的服务</h3></div>');html.push('<div class="mc-service">');html.push("<ul>");if(json.gridConfigList.length>4){n=4}else{n=json.gridConfigList.length}for(var i=0;i<n;i++){p=json.gridConfigList[i];html.push("<li>");html.push('<a href="'+p.linkAddress+'" target="_blank">');html.push('<img src="'+ec.mediaPath+p.iconPath+'">');html.push("<span>"+p.title+"</span>");if(p.semiTitle!=null||p.semiTitle!=""){html.push("<em>"+p.semiTitle+"</em>")}html.push("</a></li>")}html.push("</ul>");html.push("</div>");$("#grid_config_box").html(html.join(""));$("#grid_config_box").show();$("#grid_config_hr").show()}else{$("#grid_config_box").hide();$("#grid_config_hr").hide()}}}})};ec.ready(function(){ec.member.myCenter.load();ec.member.myCenter.myGridConfigLoad();ec.member.myCenter.personalCenterLoad();$("#base_index").attr("class","mc-index");$("#pathPoint").empty();if(ec.member.myCenter.orderCode!=""){$.ajax({url:openApiDomain+"/rms/comment/getOrderCommentStatus.json",type:"POST",dataType:"json",data:JSON.stringify({orderCode:ec.member.myCenter.orderCode,t:(new Date).getTime()}),timeout:1e4,beforeSend:function(xhr){xhr.withCredentials=true},success:function(json){var p;if(json.data&&json.data!=undefined){for(var i=0;i<json.data.length;i++){p=json.data[i];if(p.status==1){$("#orderStatus_"+p.orderCode).text("待评价");$("#comment_"+p.orderCode).show();$("#comment_"+p.orderCode).attr("href","javascript:ec.member.myCenter.commentsRealName("+p.orderCode+")")}else{if($("#orderStatus_"+p.orderCode).text().trim()=="已完成"){$("#orderStatus_"+p.orderCode).parent().hide()}}}if($(".mc-order-list ul li:visible").length<=0){$(".mc-order-list").append('<div class="mc-order-empty">当前无近期订单，前往<a href="/">首页</a>选购吧～</div>')}}}})}ec.member.myCenter.commentsRealName=function(orderCode){$.ajax({url:domainMain+"/member/addUserRemarkView.json",dataType:"json",type:"post",data:{orderCode:orderCode,t:(new Date).getTime()},timeout:1e4,success:function(json){if(json.success){ec.postTo("/member/addUserRemarkView",{orderCode:orderCode})}else{ec.account.syncCustomSession(function(callJson){if(callJson==null||callJson.customerInfo.userState==null){ec.postTo("/member/addUserRemarkView",{orderCode:orderCode});return}else{ec.member.myCenter.vildateComments(orderCode)}})}}})};ec.member.myCenter.vildateComments=function(orderCode){$.ajax({url:domainMain+"/member/addUserRemarkView.json",dataType:"json",type:"post",data:{orderCode:orderCode,t:(new Date).getTime()},timeout:1e4,error:function(){alert("读取超时，请重试！")},success:function(json){if(json.success){ec.postTo("/member/addUserRemarkView",{orderCode:orderCode})}else{ec.member.myCenter.commentsTip()}}})};ec.member.myCenter.commentsTip=function(){new ec.box($("#realNameComment").val(),{boxclass:"ol_box_4",title:"",width:540,showButton:false,autoHeight:false,onok:function(){}}).open()}});ec.member.myCenter.updateMsgState=function(mid){$.ajax({type:"POST",url:"/member/msg/update-"+mid+".json",dataType:"json",timeout:1e4,success:function(json){if(!json.success){return}},error:function(){alert("读取超时，请重试！")}})};$(function(){$(".mc-recommend ul li a").click(function(){var $li=$(this).closest("li");ec.dapClick(300140101,{name:$li.find(".p-title a").text(),ADID:$li.find("img").attr("src"),URL:$(this).attr("href"),click:1})});$(".mc-recommend .banner a").click(function(){ec.dapClick(300140101,{name:"",ADID:$(this).find("img").attr("src"),URL:$(this).attr("href"),click:1})})});